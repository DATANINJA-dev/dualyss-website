# Vulnerability Detection Patterns

Common vulnerability patterns and detection strategies. Use during code reviews, security audits, and when implementing input validation.

> **Note**: This document describes vulnerability patterns for educational purposes to help identify and avoid unsafe code.

---

## SQL Injection

**Risk**: Untrusted data executed as SQL commands.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| String concatenation in queries | Critical | Direct variable insertion into SQL |
| Missing parameterization | Critical | No prepared statements |
| Dynamic table/column names | High | User input in identifiers |
| LIKE with user input | Medium | Wildcard injection possible |

### Safe vs Unsafe Patterns

| Language | Unsafe Pattern | Safe Pattern |
|----------|---------------|--------------|
| JavaScript | Template literals in query | Parameterized queries |
| Python | f-strings in execute() | Parameterized statements |
| Java | String concatenation | PreparedStatement |
| PHP | Variable interpolation | PDO with bindParam() |

### Code Review Checklist

- [ ] All queries use parameterized statements
- [ ] No string concatenation with user input in queries
- [ ] Dynamic identifiers validated against allowlist
- [ ] ORM methods used instead of raw SQL where possible
- [ ] Error messages do not expose query structure

---

## Cross-Site Scripting (XSS)

**Risk**: Malicious scripts executed in user browsers.

### XSS Types

| Type | Vector | Impact |
|------|--------|--------|
| Reflected | URL parameters, form inputs | Session hijacking |
| Stored | Database, files | Persistent attack |
| DOM-based | Client-side JavaScript | Client manipulation |

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| innerHTML assignment | Critical | Direct HTML insertion |
| document.write() | Critical | Legacy DOM manipulation |
| Dynamic code execution | Critical | Patterns evaluating strings as code |
| href with user input | High | JavaScript URL injection |
| Unescaped template output | High | Framework-specific |

### Framework-Specific Detection

| Framework | Unsafe Pattern | Safe Alternative |
|-----------|---------------|------------------|
| React | Raw HTML insertion | Use DOMPurify first |
| Angular | bypassSecurityTrust | Avoid or sanitize |
| Vue | v-html directive | Use v-text or sanitize |
| jQuery | .html() with user data | .text() or sanitize |

### Code Review Checklist

- [ ] No direct innerHTML with user data
- [ ] External URLs validated and sanitized
- [ ] Template engine auto-escaping enabled
- [ ] User input sanitized with DOMPurify or similar
- [ ] Content-Security-Policy header configured

---

## Cross-Site Request Forgery (CSRF)

**Risk**: Unauthorized actions performed on behalf of authenticated users.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| Missing CSRF token | Critical | No protection |
| GET for state changes | High | Bookmarkable attacks |
| Predictable tokens | High | Token guessing |
| Missing SameSite cookie | Medium | Cross-origin requests |

### Framework Detection

| Framework | Protection Pattern | Missing Indicator |
|-----------|-------------------|-------------------|
| Django | csrf_protect decorator | csrf_exempt on POST |
| Express | csurf middleware | No csrfToken() call |
| Rails | protect_from_forgery | skip_before_action |
| Spring | CsrfFilter | csrf disabled |

### Code Review Checklist

- [ ] CSRF tokens on all state-changing forms
- [ ] X-CSRF-Token header on AJAX requests
- [ ] SameSite=Strict on session cookies
- [ ] Tokens validated server-side
- [ ] Tokens regenerated on login

---

## Server-Side Request Forgery (SSRF)

**Risk**: Server makes requests to unintended destinations.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| URL from user input | Critical | Direct SSRF |
| Webhook/callback URLs | High | Indirect SSRF |
| File imports from URL | High | Data exfiltration |
| PDF/Image generators | Medium | URL in documents |

### Bypass Patterns to Block

| Category | Examples |
|----------|----------|
| Internal IPs | 127.0.0.1, localhost, 0.0.0.0 |
| Private ranges | 10.x.x.x, 172.16-31.x.x, 192.168.x.x |
| IP encoding | Decimal, hex, octal representations |
| DNS rebinding | Attacker domain resolving to internal IP |
| URL schemes | file://, gopher://, dict://, ftp:// |
| IPv6 localhost | ::1, ::ffff:127.0.0.1 |

### Code Review Checklist

- [ ] URL destinations allowlisted
- [ ] Internal IPs blocked (including encoded forms)
- [ ] DNS resolution validated
- [ ] HTTP redirects handled safely (or disabled)
- [ ] Response data sanitized before return
- [ ] Non-HTTP schemes blocked

---

## Remote Code Execution (RCE)

**Risk**: Arbitrary code execution on server.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| Dynamic code execution | Critical | Patterns evaluating strings as code |
| Shell command execution | Critical | system/subprocess calls |
| Deserialization of user data | Critical | Object injection |
| Template injection | High | Server-side rendering |
| File upload without validation | High | Executable upload |

### Dangerous Functions by Language

| Language | Functions to Audit |
|----------|-------------------|
| JavaScript | Dynamic code evaluation, setTimeout with strings |
| Python | os.system(), subprocess with shell=True |
| PHP | shell functions, passthru() |
| Java | Runtime, ProcessBuilder with user input |
| Ruby | system(), backticks |

### Code Review Checklist

- [ ] No dynamic code execution with user input
- [ ] Command arguments sanitized and escaped
- [ ] Deserialization uses safe libraries
- [ ] File uploads validated (type, size, content)
- [ ] Template engines configured safely

---

## Path Traversal

**Risk**: Access to files outside intended directory.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| ../ in file paths | Critical | Directory traversal |
| User input in file paths | High | Arbitrary file access |
| Symlink following | Medium | Indirect traversal |

### Bypass Patterns

| Technique | Description |
|-----------|-------------|
| Basic traversal | Parent directory sequences |
| URL encoding | Encoded dots and slashes |
| Double encoding | Double-encoded characters |
| Unicode encoding | Various overlong encodings |
| Null byte | Truncation (older systems) |

### Code Review Checklist

- [ ] File paths normalized before use
- [ ] Base directory enforced (chroot/jail)
- [ ] User input not directly in file paths
- [ ] Symlinks not followed (or validated)
- [ ] Path separators normalized

---

## Insecure Deserialization

**Risk**: Object injection leading to RCE or data manipulation.

### Detection Indicators

| Pattern | Risk Level | Description |
|---------|------------|-------------|
| pickle.loads() with user data | Critical | Python RCE |
| unserialize() with user data | Critical | PHP RCE |
| ObjectInputStream with user data | Critical | Java RCE |
| JSON.parse() of untrusted data | Medium | Prototype pollution |

### Safe Alternatives

| Language | Unsafe | Safe Alternative |
|----------|--------|------------------|
| Python | pickle | JSON, protobuf |
| PHP | unserialize | json_decode |
| Java | ObjectInputStream | JSON with type checking |
| JavaScript | Unsafe parsing | JSON.parse with validation |

### Code Review Checklist

- [ ] Native serialization avoided for user data
- [ ] JSON schema validation on deserialized data
- [ ] Type checking after deserialization
- [ ] Integrity verification (HMAC) for serialized data
- [ ] Class allowlisting for object deserialization

---

## Detection Tools Integration

### SAST Rules

| Vulnerability | Semgrep | SonarQube |
|---------------|---------|-----------|
| SQL Injection | security.audit.sqli | S3649 |
| XSS | security.audit.xss | S5131 |
| CSRF | security.csrf | S4502 |
| SSRF | security.ssrf | S5144 |
| Path Traversal | security.path-traversal | S2083 |

### Quick Reference

| Tool | Purpose |
|------|---------|
| Semgrep | Multi-language SAST |
| Bandit | Python security linter |
| ESLint Security | JavaScript security plugin |

---

## References

- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [PortSwigger Web Security Academy](https://portswigger.net/web-security)
